name: Multi-Architecture Build

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build_arm:
        description: 'Build ARM architectures'
        required: false
        default: 'true'
        type: boolean

env:
  VCPKG_BINARY_SOURCES: 'clear;x-gha,readwrite'

jobs:
  # Build matrix for multiple architectures
  build:
    name: Build (${{ matrix.os }}, ${{ matrix.arch }}, ${{ matrix.config }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 builds
          - os: ubuntu-22.04
            arch: x64
            config: Release
            preset: linux-ninja-clang-release
            
          - os: ubuntu-22.04
            arch: x64
            config: Debug
            preset: linux-ninja-clang-debug
            
          # ARM64 builds (using QEMU emulation)
          - os: ubuntu-22.04
            arch: arm64
            config: Release
            preset: linux-arm64-gcc-release
            use_qemu: true
            
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup vcpkg cache
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
            
      - name: Set up QEMU (for ARM builds)
        if: matrix.use_qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
          
      - name: Install build dependencies (x86_64)
        if: matrix.arch == 'x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build git \
            curl zip unzip tar pkg-config \
            python3 perl nasm autoconf automake libtool
            
      - name: Install cross-compilation tools (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            build-essential cmake ninja-build git \
            curl zip unzip tar pkg-config \
            python3 perl nasm autoconf automake libtool
            
      - name: Bootstrap vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git $HOME/vcpkg
          cd $HOME/vcpkg
          git checkout 2024.12.16
          ./bootstrap-vcpkg.sh -disableMetrics
          echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV
          
      - name: Configure CMake (x86_64)
        if: matrix.arch == 'x64'
        run: |
          cmake --preset ${{ matrix.preset }}
          
      - name: Configure CMake (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          cmake -S . -B build-arm64 \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DTHEMIS_BUILD_TESTS=OFF \
            -DTHEMIS_BUILD_BENCHMARKS=OFF \
            -DTHEMIS_ENABLE_TRACING=OFF
            
      - name: Build
        run: |
          if [ "${{ matrix.arch }}" == "x64" ]; then
            cmake --build --preset ${{ matrix.preset }} -j$(nproc)
          else
            cmake --build build-arm64 --config ${{ matrix.config }} -j$(nproc)
          fi
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: themisdb-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.config }}
          path: |
            build*/themis_server
            build*/themis_demo
          retention-days: 7
          
  # Docker multi-arch build
  docker-build:
    name: Docker Multi-Arch Build
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.build_arm)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to GitHub Container Registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            
      - name: Build and push (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Build and push (ARM64 only)
        if: github.event_name != 'push' || github.ref != 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/arm64
          push: false
          tags: themisdb:arm64-test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  # Summary job
  build-summary:
    name: Build Summary
    runs-on: ubuntu-22.04
    needs: [build, docker-build]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "Build job status: ${{ needs.build.result }}"
          echo "Docker build status: ${{ needs.docker-build.result }}"
          
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "::error::Build job failed"
            exit 1
          fi
          
          echo "âœ… All builds completed successfully"
          echo "Supported architectures: x86_64, ARM64, ARMv7"
