name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Static analysis with clang-tidy
  clang-tidy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-tidy \
            clang-tools \
            cmake \
            ninja-build

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ~/vcpkg
            !~/vcpkg/buildtrees
            !~/vcpkg/downloads
          key: ubuntu-vcpkg-tidy-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ubuntu-vcpkg-tidy-

      - name: Install vcpkg
        run: |
          if [ ! -d ~/vcpkg ]; then
            git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
            cd ~/vcpkg
            git checkout beea85fdd8bf6b716acdac191cde9bfc7c72b73b
            ./bootstrap-vcpkg.sh
          fi

      - name: Configure CMake with compile commands
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_TOOLCHAIN_FILE="$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -G Ninja

      - name: Run clang-tidy
        run: |
          # Create .clang-tidy config if not exists
          if [ ! -f .clang-tidy ]; then
            cat > .clang-tidy << 'EOF'
          Checks: >
            -*,
            bugprone-*,
            clang-analyzer-*,
            cppcoreguidelines-*,
            modernize-*,
            performance-*,
            readability-*,
            -modernize-use-trailing-return-type,
            -cppcoreguidelines-avoid-magic-numbers,
            -readability-magic-numbers,
            -cppcoreguidelines-pro-bounds-pointer-arithmetic,
            -cppcoreguidelines-pro-type-reinterpret-cast,
            -cppcoreguidelines-avoid-c-arrays,
            -modernize-avoid-c-arrays
          WarningsAsErrors: ''
          HeaderFilterRegex: '.*'
          FormatStyle: 'file'
          EOF
          fi
          
          # Run clang-tidy on source files
          find src include -name '*.cpp' -o -name '*.h' | \
            xargs clang-tidy -p build --quiet --warnings-as-errors='' \
            > clang-tidy-report.txt 2>&1 || true
          
          # Show summary
          echo "=== Clang-Tidy Analysis Summary ==="
          grep -E "warning:|error:" clang-tidy-report.txt | wc -l || echo "0"
          echo "warnings/errors found"
          
          # Show top issues
          echo ""
          echo "=== Top Issues ==="
          grep -E "warning:" clang-tidy-report.txt | head -20 || true

      - name: Upload clang-tidy report
        uses: actions/upload-artifact@v4
        with:
          name: clang-tidy-report
          path: clang-tidy-report.txt
          retention-days: 30

  # C++ linting with cppcheck
  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck \
            --enable=all \
            --std=c++17 \
            --language=c++ \
            --platform=unix64 \
            --suppress=missingIncludeSystem \
            --suppress=unmatchedSuppression \
            --suppress=unusedFunction \
            --inline-suppr \
            --xml \
            --xml-version=2 \
            -I include/ \
            src/ \
            2> cppcheck-report.xml || true
          
          # Convert XML to human-readable format
          cppcheck \
            --enable=all \
            --std=c++17 \
            --language=c++ \
            --platform=unix64 \
            --suppress=missingIncludeSystem \
            --suppress=unmatchedSuppression \
            --suppress=unusedFunction \
            --inline-suppr \
            -I include/ \
            src/ \
            2> cppcheck-report.txt || true
          
          # Show summary
          echo "=== Cppcheck Analysis Summary ==="
          grep -E "\[" cppcheck-report.txt | wc -l || echo "0"
          echo "issues found"
          
          echo ""
          echo "=== Issues by Severity ==="
          grep -oP '\[\K[^\]]+' cppcheck-report.txt | sort | uniq -c || true
          
          echo ""
          echo "=== Sample Issues ==="
          head -30 cppcheck-report.txt || true

      - name: Upload cppcheck XML report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-xml-report
          path: cppcheck-report.xml
          retention-days: 30

      - name: Upload cppcheck text report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-text-report
          path: cppcheck-report.txt
          retention-days: 30

  # Code coverage with gcov/lcov
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            lcov \
            gcovr

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ~/vcpkg
            !~/vcpkg/buildtrees
            !~/vcpkg/downloads
          key: ubuntu-vcpkg-coverage-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ubuntu-vcpkg-coverage-

      - name: Install vcpkg
        run: |
          if [ ! -d ~/vcpkg ]; then
            git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
            cd ~/vcpkg
            git checkout beea85fdd8bf6b716acdac191cde9bfc7c72b73b
            ./bootstrap-vcpkg.sh
          fi

      - name: Configure CMake with coverage
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_TOOLCHAIN_FILE="$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            -G Ninja

      - name: Build with coverage
        run: cmake --build build --parallel 2

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --verbose || true
          cd ..

      - name: Generate coverage report (lcov)
        run: |
          # Create coverage directory
          mkdir -p coverage
          
          # Capture coverage data
          lcov \
            --capture \
            --directory build \
            --output-file coverage/coverage.info \
            --rc lcov_branch_coverage=1 \
            --ignore-errors mismatch
          
          # Filter out system headers and test files
          lcov \
            --remove coverage/coverage.info \
            '/usr/*' \
            '*/vcpkg_installed/*' \
            '*/tests/*' \
            '*/build/*' \
            --output-file coverage/coverage-filtered.info \
            --rc lcov_branch_coverage=1
          
          # Generate HTML report
          genhtml \
            coverage/coverage-filtered.info \
            --output-directory coverage/html \
            --title "ThemisDB Code Coverage" \
            --legend \
            --show-details \
            --branch-coverage
          
          # Generate summary
          lcov \
            --list coverage/coverage-filtered.info \
            --rc lcov_branch_coverage=1 \
            > coverage/summary.txt
          
          echo "=== Coverage Summary ==="
          cat coverage/summary.txt

      - name: Generate coverage badge data
        run: |
          # Extract total coverage percentage
          COVERAGE=$(lcov --summary coverage/coverage-filtered.info 2>&1 | \
            grep "lines" | \
            grep -oP '\d+\.\d+(?=%)' || echo "0.0")
          
          echo "Total line coverage: $COVERAGE%"
          echo "$COVERAGE" > coverage/coverage-percentage.txt
          
          # Create badge JSON
          cat > coverage/coverage-badge.json << EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "$COVERAGE%",
            "color": "brightgreen"
          }
          EOF

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage/coverage-percentage.txt', 'utf8').trim();
            const summary = fs.readFileSync('coverage/summary.txt', 'utf8');
            
            const body = `## üìä Code Coverage Report
            
            **Total Coverage:** ${coverage}%
            
            <details>
            <summary>Detailed Coverage Summary</summary>
            
            \`\`\`
            ${summary}
            \`\`\`
            
            </details>
            
            Full HTML report available in CI artifacts.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Secret scanning with Gitleaks
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for premium features

      - name: Generate Gitleaks report
        if: always()
        run: |
          # Install gitleaks if action didn't run
          if ! command -v gitleaks &> /dev/null; then
            wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz
            tar -xzf gitleaks_8.18.4_linux_x64.tar.gz
            sudo mv gitleaks /usr/local/bin/
          fi
          
          # Run comprehensive scan
          gitleaks detect \
            --source . \
            --report-format json \
            --report-path gitleaks-report.json \
            --verbose \
            --no-git || true
          
          # Generate human-readable summary
          if [ -f gitleaks-report.json ]; then
            echo "=== Gitleaks Secret Scanning Summary ===" > gitleaks-summary.txt
            jq -r '.[] | "[\(.RuleID)] \(.File):\(.StartLine) - \(.Description)"' \
              gitleaks-report.json >> gitleaks-summary.txt 2>/dev/null || \
              echo "No secrets detected" > gitleaks-summary.txt
            
            cat gitleaks-summary.txt
          else
            echo "No secrets detected" > gitleaks-summary.txt
          fi

      - name: Upload Gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: |
            gitleaks-report.json
            gitleaks-summary.txt
          retention-days: 30

      - name: Fail on secrets found
        if: always()
        run: |
          if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ]; then
            LEAK_COUNT=$(jq length gitleaks-report.json 2>/dev/null || echo 0)
            if [ "$LEAK_COUNT" -gt 0 ]; then
              echo "‚ùå Found $LEAK_COUNT potential secret(s)"
              echo "Review gitleaks-report.json for details"
              exit 1
            fi
          fi
          echo "‚úÖ No secrets detected"

  # Summary job
  quality-summary:
    runs-on: ubuntu-latest
    needs: [clang-tidy, cppcheck, coverage, gitleaks]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "=== Code Quality Pipeline Summary ==="
          echo ""
          echo "Clang-Tidy: ${{ needs.clang-tidy.result }}"
          echo "Cppcheck: ${{ needs.cppcheck.result }}"
          echo "Coverage: ${{ needs.coverage.result }}"
          echo "Gitleaks: ${{ needs.gitleaks.result }}"
          echo ""
          
          if [ "${{ needs.gitleaks.result }}" = "failure" ]; then
            echo "‚ùå Pipeline failed due to secret detection"
            exit 1
          fi
          
          if [ "${{ needs.coverage.result }}" = "failure" ]; then
            echo "‚ö†Ô∏è  Coverage generation failed"
          fi
          
          echo "‚úÖ Code quality checks completed"
