name: Coverage Badge

on:
  workflow_dispatch:  # Manually triggered only
  # push:
  #   branches: [ main ]

permissions:
  contents: write

jobs:
  coverage-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build lcov gcovr

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ~/vcpkg
            !~/vcpkg/buildtrees
            !~/vcpkg/downloads
          key: ubuntu-vcpkg-coverage-${{ hashFiles('vcpkg.json') }}

      - name: Install vcpkg
        run: |
          if [ ! -d ~/vcpkg ]; then
            git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
            cd ~/vcpkg
            git checkout beea85fdd8bf6b716acdac191cde9bfc7c72b73b
            ./bootstrap-vcpkg.sh
          fi

      - name: Build with coverage
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_TOOLCHAIN_FILE="$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            -G Ninja
          cmake --build build --parallel 2

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure || true

      - name: Generate coverage
        run: |
          mkdir -p coverage
          lcov --capture --directory build --output-file coverage/coverage.info --rc lcov_branch_coverage=1 --ignore-errors mismatch
          lcov --remove coverage/coverage.info '/usr/*' '*/vcpkg_installed/*' '*/tests/*' '*/build/*' \
            --output-file coverage/coverage-filtered.info --rc lcov_branch_coverage=1
          
          # Extract percentage
          COVERAGE=$(lcov --summary coverage/coverage-filtered.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+(?=%)' || echo "0.0")
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          echo "Coverage: $COVERAGE%"

      - name: Create coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: YOUR_GIST_ID  # Replace with actual Gist ID
          filename: themisdb-coverage.json
          label: coverage
          message: ${{ env.COVERAGE }}%
          valColorRange: ${{ env.COVERAGE }}
          maxColorRange: 90
          minColorRange: 50

      - name: Generate HTML report
        run: |
          genhtml coverage/coverage-filtered.info \
            --output-directory coverage/html \
            --title "ThemisDB Code Coverage" \
            --legend --show-details --branch-coverage

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage/html
          destination_dir: coverage
          keep_files: false
