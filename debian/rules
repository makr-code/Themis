#!/usr/bin/make -f

# Enable all hardening flags
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

# Use dpkg-buildflags to get compiler flags
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/buildflags.mk

%:
	dh $@ --buildsystem=cmake --parallel

override_dh_auto_configure:
	dh_auto_configure -- \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DTHEMIS_BUILD_TESTS=OFF \
		-DTHEMIS_BUILD_BENCHMARKS=OFF \
		-DTHEMIS_ENABLE_GPU=OFF \
		-DTHEMIS_STRICT_BUILD=OFF \
		-DBUILD_SHARED_LIBS=OFF

override_dh_auto_build:
	dh_auto_build

override_dh_auto_install:
	dh_auto_install
	# Install systemd service file
	install -D -m 644 debian/themisdb.service \
		debian/themisdb/lib/systemd/system/themisdb.service
	# Install default configuration
	install -D -m 644 config/config.yaml \
		debian/themisdb/etc/themisdb/config.yaml
	# Create data directory
	install -d -m 755 debian/themisdb/var/lib/themisdb

override_dh_installsystemd:
	dh_installsystemd --name=themisdb

override_dh_auto_test:
	# Skip tests during package build (can be enabled with DEB_BUILD_OPTIONS=nocheck)
	@echo "Skipping tests (use DEB_BUILD_OPTIONS to enable)"
